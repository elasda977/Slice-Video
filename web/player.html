<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player - HLS Video Platform</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">üé¨</span>
                <span class="logo-text">HLS Video Platform</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="upload.html">Upload</a></li>
                <li><a href="player.html" class="active">Player</a></li>
                <li><a href="manage.html">Manage</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card" style="max-width: 1200px; margin: 40px auto;">
            <h1 style="text-align: center; margin-bottom: 10px; color: var(--dark);">‚ñ∂Ô∏è HLS Video Player</h1>
            <p class="subtitle" style="text-align: center; color: var(--gray); margin-bottom: 30px;">Stream videos with download protection</p>

            <div class="video-wrapper" style="position: relative; background: #000; border-radius: var(--radius); overflow: hidden; margin-bottom: 20px;">
                <video id="videoPlayer" controls style="width: 100%; height: auto; display: block;">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="form-group">
                <label for="playlistUrl">Playlist URL (.m3u8 file):</label>
                <input
                    type="text"
                    id="playlistUrl"
                    class="form-control"
                    placeholder="e.g., output/myvideo/playlist.m3u8"
                    value="output/test-mantra/playlist.m3u8"
                >
            </div>

            <button onclick="loadVideo()" class="btn btn-primary" style="width: 100%;">
                <span class="btn-icon">üìÇ</span>
                Load Video
            </button>

            <div id="status" class="alert hidden" style="margin-top: 20px;"></div>

            <div class="info-banner" style="margin-top: 30px;">
                <div class="info-icon">‚ÑπÔ∏è</div>
                <div class="info-content">
                    <h3>How it works:</h3>
                    <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                        <li><strong>HLS (HTTP Live Streaming):</strong> Videos are split into small .ts segments (typically 6-10 seconds each)</li>
                        <li><strong>Download Protection:</strong> Users can't easily download the full video - only small segments</li>
                        <li><strong>Playlist (.m3u8):</strong> Contains the list of video segments to play in order</li>
                        <li><strong>Browser-Native:</strong> Works in all modern browsers without plugins</li>
                        <li><strong>Adaptive Streaming:</strong> Can support multiple quality levels (if configured)</li>
                    </ul>
                </div>
            </div>

            <div class="info-banner" style="margin-top: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning-color);">
                <div class="info-icon">üí°</div>
                <div class="info-content">
                    <h3 style="color: var(--warning-color);">Quick Start:</h3>
                    <ol style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                        <li>Upload your video using the <a href="upload.html" style="color: var(--primary-color);">Upload page</a></li>
                        <li>Convert it to HLS format using the conversion script</li>
                        <li>Enter the path above: <code style="background: var(--dark); color: var(--white); padding: 2px 8px; border-radius: 4px;">output/yourvideo/playlist.m3u8</code></li>
                        <li>Click "Load Video" to start streaming</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Recently Played Section -->
        <div class="card" style="max-width: 1200px; margin: 40px auto;">
            <h2 style="color: var(--dark); margin-bottom: 20px;">üì∫ Recently Played</h2>
            <div id="recentVideos">
                <p style="color: var(--gray); text-align: center; padding: 40px;">
                    No videos played yet. Start watching to see your recent videos here!
                </p>
            </div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="card" style="max-width: 1200px; margin: 40px auto;">
            <h2 style="color: var(--dark); margin-bottom: 20px;">‚å®Ô∏è Keyboard Shortcuts</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>Space</strong> - Play/Pause
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>‚Üí</strong> - Forward 5s
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>‚Üê</strong> - Backward 5s
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>‚Üë</strong> - Volume Up
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>‚Üì</strong> - Volume Down
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>F</strong> - Fullscreen
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>M</strong> - Mute/Unmute
                </div>
                <div style="padding: 15px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                    <strong>0-9</strong> - Jump to %
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 HLS Video Platform. Powered by FFmpeg.</p>
        </div>
    </footer>

    <script>
        const video = document.getElementById('videoPlayer');
        const playlistInput = document.getElementById('playlistUrl');
        const statusDiv = document.getElementById('status');
        let hlsInstance = null;

        function showStatus(message, type = 'success') {
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function loadVideo() {
            const playlistUrl = playlistInput.value.trim();

            if (!playlistUrl) {
                showStatus('Please enter a playlist URL', 'danger');
                return;
            }

            if (!playlistUrl.endsWith('.m3u8')) {
                showStatus('URL must point to a .m3u8 playlist file', 'danger');
                return;
            }

            // Save to recent videos
            saveToRecent(playlistUrl);

            // Check if browser supports HLS natively (Safari)
            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = playlistUrl;
                showStatus('‚úì Video loaded successfully!', 'success');
                video.addEventListener('error', function() {
                    showStatus('Failed to load video. Check the playlist URL and file path.', 'danger');
                });
            }
            // For other browsers, use HLS.js library
            else if (typeof Hls !== 'undefined') {
                if (Hls.isSupported()) {
                    // Destroy previous instance if exists
                    if (hlsInstance) {
                        hlsInstance.destroy();
                    }

                    hlsInstance = new Hls({
                        enableWorker: true,
                        lowLatencyMode: false,
                    });

                    hlsInstance.loadSource(playlistUrl);
                    hlsInstance.attachMedia(video);

                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                        showStatus('‚úì Video loaded successfully!', 'success');
                        video.play();
                    });

                    hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                        if (data.fatal) {
                            showStatus(`Error loading video: ${data.type} - ${data.details}`, 'danger');
                        }
                    });
                } else {
                    showStatus('HLS is not supported in this browser', 'danger');
                }
            }
            // Fallback: try direct playback
            else {
                video.src = playlistUrl;
                showStatus('‚ö†Ô∏è Limited HLS support. Using fallback mode.', 'warning');
            }
        }

        function saveToRecent(url) {
            let recent = JSON.parse(localStorage.getItem('recentVideos') || '[]');
            const videoName = url.split('/').filter(p => p).pop().replace('playlist.m3u8', '');

            // Remove if already exists
            recent = recent.filter(v => v.url !== url);

            // Add to front
            recent.unshift({
                url: url,
                name: videoName,
                timestamp: new Date().toISOString()
            });

            // Keep only last 10
            recent = recent.slice(0, 10);

            localStorage.setItem('recentVideos', JSON.stringify(recent));
            updateRecentVideos();
        }

        function updateRecentVideos() {
            const recent = JSON.parse(localStorage.getItem('recentVideos') || '[]');
            const container = document.getElementById('recentVideos');

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">No videos played yet. Start watching to see your recent videos here!</p>';
                return;
            }

            container.innerHTML = '<div class="video-grid">' +
                recent.map(v => `
                    <div class="video-card">
                        <div class="video-thumbnail">üé¨</div>
                        <div class="video-info">
                            <div class="video-title">${v.name || 'Untitled'}</div>
                            <div class="video-meta">${new Date(v.timestamp).toLocaleString()}</div>
                            <div class="video-actions">
                                <button class="btn btn-primary btn-sm" onclick="loadRecentVideo('${v.url}')">
                                    ‚ñ∂Ô∏è Play
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="removeRecent('${v.url}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') +
                '</div>';
        }

        function loadRecentVideo(url) {
            playlistInput.value = url;
            loadVideo();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function removeRecent(url) {
            let recent = JSON.parse(localStorage.getItem('recentVideos') || '[]');
            recent = recent.filter(v => v.url !== url);
            localStorage.setItem('recentVideos', JSON.stringify(recent));
            updateRecentVideos();
        }

        // Load HLS.js library for browsers that don't support HLS natively
        if (!video.canPlayType('application/vnd.apple.mpegurl')) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
            document.head.appendChild(script);
        }

        // Prevent right-click context menu on video (additional protection)
        video.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable keyboard shortcuts that might allow download
        video.addEventListener('keydown', function(e) {
            // Prevent Ctrl+S (Save)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                return false;
            }
        });

        // Load recent videos on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateRecentVideos();
        });

        // Auto-load if URL parameter exists
        const urlParams = new URLSearchParams(window.location.search);
        const autoPlaylist = urlParams.get('playlist');
        if (autoPlaylist) {
            playlistInput.value = decodeURIComponent(autoPlaylist);
            loadVideo();
        }
    </script>
</body>
</html>
